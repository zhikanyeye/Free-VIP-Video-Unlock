document.addEventListener('DOMContentLoaded', function() {
    // è·å–DOMå…ƒç´ 
    const videoUrlInput = document.getElementById('videoUrl');
    const parseBtn = document.getElementById('parseBtn');
    const playerSection = document.getElementById('playerSection');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoTitle = document.getElementById('videoTitle');
    const closePlayer = document.getElementById('closePlayer');
    const speedTestBtn = document.getElementById('speedTestBtn');
    const apiListBtn = document.getElementById('apiListBtn');
    const helpBtn = document.getElementById('helpBtn');
    const statusInfo = document.getElementById('statusInfo');
    const statusText = document.getElementById('statusText');
    const apiNameBadge = document.getElementById('apiNameBadge');
    const dplayerContainer = document.getElementById('dplayer-container');
    const iframeContainer = document.getElementById('iframe-container');

    // DPlayer å®ä¾‹
    let dplayer = null;

    // è®¾å¤‡æ£€æµ‹
    const deviceInfo = {
        isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isMac: /Macintosh|MacIntel|MacPPC|Mac68K/.test(navigator.platform),
        isWindows: /Win32|Win64|Windows|WinCE/.test(navigator.platform),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        isChrome: /Chrome/.test(navigator.userAgent),
        isFirefox: /Firefox/.test(navigator.userAgent)
    };

    // è§£æAPIæ¥å£æ•°ç»„ - æ›´æ–°çš„é«˜è´¨é‡æ¥å£
    const apiList = [
        {
            name: "èœœç³–è§£æ",
            url: "https://mtjiexi.cc:966/?url=",
            priority: 1
        },
        {
            name: "ç›–å­è§£æ",
            url: "https://gayzyjiexi.com/play/?url=",
            priority: 2
        },
        {
            name: "è±†ç“£è§£æ",
            url: "https://www.dbjiexi.com:966/jx/?url=",
            priority: 3
        },
        {
            name: "é›¨å…”è§£æ",
            url: "https://yutujx.com/?url=",
            priority: 4
        },
        {
            name: "å¤§å¥¶å­è§£æ",
            url: "https://jiexidanaizi.com/?url=",
            priority: 5
        },
        {
            name: "973è§£æ",
            url: "https://jx.973973.xyz/?url=",
            priority: 6
        },
        {
            name: "å°èš‚èšè§£æ1",
            url: "https://jx.xmflv.com/?url=",
            priority: 7
        },
        {
            name: "å°èš‚èšè§£æ2",
            url: "https://jx.xmflv.cc/?url=",
            priority: 8
        },
        {
            name: "M1907è§£æ",
            url: "https://z1.m1907.top/?jx=",
            priority: 9
        }
    ];

    // æ¥å£æµ‹é€Ÿç»“æœç¼“å­˜
    let speedTestResults = [];
    let bestApiIndex = 0;
    let isSpeedTesting = false;

    // åˆå§‹åŒ–è®¾å¤‡ä¼˜åŒ–
    initializeDeviceOptimizations();

    // è®¾å¤‡ä¼˜åŒ–åˆå§‹åŒ–
    function initializeDeviceOptimizations() {
        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        if (deviceInfo.isMobile) {
            document.body.classList.add('mobile-device');
            
            // iOS ç‰¹æ®Šå¤„ç†
            if (deviceInfo.isIOS) {
                document.body.classList.add('ios-device');
                // é˜²æ­¢ iOS Safari ç¼©æ”¾
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }
            }
            
            // Android ç‰¹æ®Šå¤„ç†
            if (deviceInfo.isAndroid) {
                document.body.classList.add('android-device');
            }
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
            addTouchOptimizations();
        }
        
        // Mac è®¾å¤‡ä¼˜åŒ–
        if (deviceInfo.isMac) {
            document.body.classList.add('mac-device');
        }
        
        // Windows è®¾å¤‡ä¼˜åŒ–
        if (deviceInfo.isWindows) {
            document.body.classList.add('windows-device');
        }
        
        // æµè§ˆå™¨ç‰¹å®šä¼˜åŒ–
        if (deviceInfo.isSafari) {
            document.body.classList.add('safari-browser');
        }
        
        updateStatus('ç³»ç»Ÿå·²ä¼˜åŒ–é€‚é…æ‚¨çš„è®¾å¤‡', 'success');
    }

    // è§¦æ‘¸è®¾å¤‡ä¼˜åŒ–
    function addTouchOptimizations() {
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    }

    // åˆå§‹åŒ– DPlayer
    function initializeDPlayer(videoUrl, videoInfo) {
        // é”€æ¯ä¹‹å‰çš„å®ä¾‹
        if (dplayer) {
            dplayer.destroy();
            dplayer = null;
        }
        
        // æ˜¾ç¤º DPlayer å®¹å™¨ï¼Œéšè— iframe
        dplayerContainer.style.display = 'block';
        iframeContainer.classList.add('d-none');
        
        // DPlayer é…ç½®
        const dplayerConfig = {
            container: dplayerContainer,
            video: {
                url: videoUrl,
                type: 'auto',
                customType: {
                    'customHls': function (video, player) {
                        if (window.Hls && Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(video.src);
                            hls.attachMedia(video);
                        }
                    }
                }
            },
            autoplay: !deviceInfo.isMobile, // ç§»åŠ¨ç«¯ä¸è‡ªåŠ¨æ’­æ”¾
            theme: '#2563eb',
            loop: false,
            lang: 'zh-cn',
            screenshot: false,
            hotkey: !deviceInfo.isMobile, // ç§»åŠ¨ç«¯ç¦ç”¨å¿«æ·é”®
            preload: deviceInfo.isMobile ? 'metadata' : 'auto',
            volume: 0.8,
            mutex: true,
            contextmenu: [
                {
                    text: 'è§†é¢‘è§£æå·¥å…·',
                    link: window.location.href
                },
                {
                    text: 'å…³äºé¡¹ç›®',
                    click: function () {
                        showHelpModal();
                    }
                }
            ]
        };
        
        // ç§»åŠ¨ç«¯ç‰¹æ®Šé…ç½®
        if (deviceInfo.isMobile) {
            dplayerConfig.playbackSpeed = [0.5, 0.75, 1, 1.25, 1.5]; // ç®€åŒ–æ’­æ”¾é€Ÿåº¦é€‰é¡¹
            dplayerConfig.subtitle = false; // ç§»åŠ¨ç«¯ç¦ç”¨å­—å¹•
        }
        
        try {
            dplayer = new DPlayer(dplayerConfig);
            
            // ç»‘å®šæ’­æ”¾å™¨äº‹ä»¶
            bindDPlayerEvents(videoInfo);
            
            return true;
        } catch (error) {
            console.error('DPlayer åˆå§‹åŒ–å¤±è´¥:', error);
            showNotification('DPlayer åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ’­æ”¾å™¨', 'warning');
            return false;
        }
    }

    // ç»‘å®š DPlayer äº‹ä»¶
    function bindDPlayerEvents(videoInfo) {
        if (!dplayer) return;
        
        dplayer.on('loadstart', function () {
            updateStatus('è§†é¢‘å¼€å§‹åŠ è½½...', 'info');
        });
        
        dplayer.on('loadeddata', function () {
            updateStatus('è§†é¢‘åŠ è½½å®Œæˆï¼Œå¯ä»¥æ’­æ”¾', 'success');
        });
        
        dplayer.on('play', function () {
            updateStatus('è§†é¢‘æ­£åœ¨æ’­æ”¾', 'success');
        });
        
        dplayer.on('pause', function () {
            updateStatus('è§†é¢‘å·²æš‚åœ', 'info');
        });
        
        dplayer.on('error', function (e) {
            console.error('DPlayer æ’­æ”¾é”™è¯¯:', e);
            showNotification('æ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨åˆ‡æ¢å¤‡ç”¨æ’­æ”¾å™¨...', 'error');
            fallbackToIframe(videoInfo);
        });
        
        // ç§»åŠ¨ç«¯ç‰¹æ®Šäº‹ä»¶å¤„ç†
        if (deviceInfo.isMobile) {
            dplayer.on('fullscreen', function () {
                // ç§»åŠ¨ç«¯å…¨å±æ—¶çš„ç‰¹æ®Šå¤„ç†
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {
                        // é™é»˜å¤±è´¥ï¼ŒæŸäº›æµè§ˆå™¨ä¸æ”¯æŒ
                    });
                }
            });
            
            dplayer.on('fullscreen_cancel', function () {
                // é€€å‡ºå…¨å±æ—¶è§£é”å±å¹•æ–¹å‘
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            });
        }
    }

    // å¤‡ç”¨æ’­æ”¾å™¨ (iframe)
    function fallbackToIframe(videoInfo) {
        // éšè— DPlayerï¼Œæ˜¾ç¤º iframe
        dplayerContainer.style.display = 'none';
        iframeContainer.classList.remove('d-none');
        
        // è®¾ç½® iframe æº
        videoPlayer.src = videoInfo.fullUrl;
        
        updateStatus('å·²åˆ‡æ¢åˆ°å¤‡ç”¨æ’­æ”¾å™¨', 'info');
    }
    
    // è§£æAPIæ¥å£æ•°ç»„ - æ›´æ–°çš„é«˜è´¨é‡æ¥å£
    const apiList = [
        {
            name: "èœœç³–è§£æ",
            url: "https://mtjiexi.cc:966/?url=",
            priority: 1
        },
        {
            name: "ç›–å­è§£æ",
            url: "https://gayzyjiexi.com/play/?url=",
            priority: 2
        },
        {
            name: "è±†ç“£è§£æ",
            url: "https://www.dbjiexi.com:966/jx/?url=",
            priority: 3
        },
        {
            name: "é›¨å…”è§£æ",
            url: "https://yutujx.com/?url=",
            priority: 4
        },
        {
            name: "å¤§å¥¶å­è§£æ",
            url: "https://jiexidanaizi.com/?url=",
            priority: 5
        },
        {
            name: "973è§£æ",
            url: "https://jx.973973.xyz/?url=",
            priority: 6
        },
        {
            name: "å°èš‚èšè§£æ1",
            url: "https://jx.xmflv.com/?url=",
            priority: 7
        },
        {
            name: "å°èš‚èšè§£æ2",
            url: "https://jx.xmflv.cc/?url=",
            priority: 8
        },
        {
            name: "M1907è§£æ",
            url: "https://z1.m1907.top/?jx=",
            priority: 9
        }
    ];

    // æ¥å£æµ‹é€Ÿç»“æœç¼“å­˜
    let speedTestResults = [];
    let bestApiIndex = 0;
    let isSpeedTesting = false;
    
    // ç‚¹å‡»è§£ææŒ‰é’®äº‹ä»¶
    parseBtn.addEventListener('click', function() {
        parseVideo();
    });
    
    // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    videoUrlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            parseVideo();
        }
    });
    
    // å…³é—­æ’­æ”¾å™¨
    closePlayer.addEventListener('click', function() {
        // é”€æ¯ DPlayer å®ä¾‹
        if (dplayer) {
            dplayer.destroy();
            dplayer = null;
        }
        
        // æ¸…ç©º iframe
        videoPlayer.src = '';
        
        // éšè—æ’­æ”¾å™¨
        playerSection.classList.add('d-none');
        
        // é‡ç½®æ’­æ”¾å™¨å®¹å™¨çŠ¶æ€
        dplayerContainer.style.display = 'none';
        iframeContainer.classList.add('d-none');
        
        // ç§»é™¤é‡è¯•å®¹å™¨
        const retryContainer = document.querySelector('.retry-container');
        if (retryContainer) {
            retryContainer.remove();
        }
        
        updateStatus('æ’­æ”¾å™¨å·²å…³é—­', 'info');
    });

    // åŠŸèƒ½æŒ‰é’®äº‹ä»¶
    speedTestBtn.addEventListener('click', function() {
        window.open('compatibility-test.html', '_blank');
    });

    quickSpeedTestBtn.addEventListener('click', function() {
        performQuickSpeedTest();
    });

    apiListBtn.addEventListener('click', function() {
        showApiList();
    });

    helpBtn.addEventListener('click', function() {
        showHelpModal();
    });

    // å¿«é€Ÿæµ‹é€ŸåŠŸèƒ½ï¼ˆä»…æµ‹è¯•å‰3ä¸ªæ¥å£ï¼‰
    async function performQuickSpeedTest() {
        if (isSpeedTesting) return;
        
        quickSpeedTestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å¿«é€Ÿæµ‹é€Ÿä¸­...';
        quickSpeedTestBtn.disabled = true;
        updateStatus('æ­£åœ¨è¿›è¡Œå¿«é€Ÿæ¥å£æµ‹é€Ÿ...', 'info');
        
        try {
            // ä»…æµ‹è¯•å‰3ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„æ¥å£
            const testApis = apiList.slice(0, 3);
            const testUrl = 'https://v.qq.com/x/cover/mzc00200mp8vo9l.html'; // é»˜è®¤æµ‹è¯•é“¾æ¥
            
            isSpeedTesting = true;
            const quickResults = [];
            
            for (let i = 0; i < testApis.length; i++) {
                const api = testApis[i];
                try {
                    const startTime = performance.now();
                    const fullUrl = api.url + encodeURIComponent(testUrl);
                    
                    updateStatus(`æ­£åœ¨æµ‹è¯• ${api.name}...`, 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    await fetch(fullUrl, {
                        method: 'HEAD',
                        signal: controller.signal,
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    quickResults.push({
                        name: api.name,
                        responseTime: responseTime,
                        available: true
                    });
                    
                } catch (error) {
                    quickResults.push({
                        name: api.name,
                        responseTime: 10000,
                        available: false
                    });
                }
            }
            
            // æ›´æ–°æœ€ä½³æ¥å£ç´¢å¼•
            const bestResult = quickResults.find(r => r.available);
            if (bestResult) {
                bestApiIndex = apiList.findIndex(api => api.name === bestResult.name);
                const avgTime = quickResults.filter(r => r.available)
                    .reduce((sum, r) => sum + r.responseTime, 0) / quickResults.filter(r => r.available).length;
                
                updateStatus(`å¿«é€Ÿæµ‹é€Ÿå®Œæˆï¼æœ€ä½³æ¥å£ï¼š${bestResult.name} (${Math.round(bestResult.responseTime)}ms)`, 'success');
                showNotification(`å¿«é€Ÿæµ‹é€Ÿå®Œæˆï¼Œæ¨èä½¿ç”¨ ${bestResult.name}`, 'success');
            } else {
                updateStatus('å¿«é€Ÿæµ‹é€Ÿå¤±è´¥ï¼Œæ‰€æœ‰æ¥å£æ— å“åº”', 'error');
                showNotification('å¿«é€Ÿæµ‹é€Ÿå¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
            
        } catch (error) {
            updateStatus('å¿«é€Ÿæµ‹é€Ÿå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } finally {
            isSpeedTesting = false;
            quickSpeedTestBtn.innerHTML = '<i class="fas fa-bolt"></i> å¿«é€Ÿæµ‹é€Ÿ';
            quickSpeedTestBtn.disabled = false;
        }
    }

    // æ‰‹åŠ¨è¯¦ç»†æµ‹é€ŸåŠŸèƒ½ - åŸºäºå½“å‰è§†é¢‘é“¾æ¥è¿›è¡Œå®é™…æµ‹è¯•
    async function performSpeedTestManual() {
        if (isSpeedTesting) {
            showNotification('æ­£åœ¨è¿›è¡Œæ™ºèƒ½æµ‹é€Ÿï¼Œè¯·ç¨å€™...', 'info');
            return;
        }

        const videoUrl = videoUrlInput.value.trim();
        if (!videoUrl) {
            showNotification('è¯·å…ˆè¾“å…¥è§†é¢‘é“¾æ¥å†è¿›è¡Œæµ‹é€Ÿ', 'warning');
            return;
        }

        if (!isValidUrl(videoUrl)) {
            showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'error');
            return;
        }
        
        speedTestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> è¯¦ç»†æµ‹é€Ÿä¸­...';
        speedTestBtn.disabled = true;
        updateStatus('æ­£åœ¨åŸºäºå½“å‰è§†é¢‘é“¾æ¥è¿›è¡Œè¯¦ç»†æ¥å£æµ‹é€Ÿ...', 'info');
        
        try {
            await performSpeedTest();
            const bestApi = apiList[bestApiIndex];
            const responseTime = speedTestResults.find(r => r.index === bestApiIndex)?.responseTime;
            const timeDisplay = responseTime ? ` (${Math.round(responseTime)}ms)` : '';
            
            updateStatus(`è¯¦ç»†æµ‹é€Ÿå®Œæˆï¼æ¨èæ¥å£ï¼š${bestApi.name}${timeDisplay}`, 'success');
            showNotification(`æ¨èä½¿ç”¨ï¼š${bestApi.name}${timeDisplay}`, 'success');
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœæ¨¡æ€æ¡†
            showDetailedSpeedResults();
        } catch (error) {
            updateStatus('è¯¦ç»†æµ‹é€Ÿå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            showNotification('è¯¦ç»†æµ‹é€Ÿå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        } finally {
            speedTestBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> è¯¦ç»†æµ‹é€Ÿ';
            speedTestBtn.disabled = false;
        }
    }

    // æ˜¾ç¤ºè¯¦ç»†æµ‹é€Ÿç»“æœ
    function showDetailedSpeedResults() {
        const availableApis = speedTestResults.filter(r => r.available);
        const failedApis = speedTestResults.filter(r => !r.available);
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-tachometer-alt"></i> è¯¦ç»†æµ‹é€Ÿç»“æœ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            åŸºäºå½“å‰è§†é¢‘é“¾æ¥çš„å®é™…è§£ææµ‹è¯•ç»“æœã€‚è§£æè§†é¢‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨æœ€å¿«çš„å¯ç”¨æ¥å£ã€‚
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <div class="h4 text-success">${availableApis.length}</div>
                                <div class="text-muted">å¯ç”¨æ¥å£</div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-danger">${failedApis.length}</div>
                                <div class="text-muted">å¤±è´¥æ¥å£</div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="h4 text-primary">${availableApis.length > 0 ? Math.round(availableApis[0].responseTime) : '-'}</div>
                                <div class="text-muted">æœ€å¿«å“åº”(ms)</div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æ’å</th>
                                        <th>æ¥å£åç§°</th>
                                        <th>å“åº”æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è¯„çº§</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${speedTestResults.map((result, index) => {
                                        const availableIndex = availableApis.findIndex(a => a.index === result.index);
                                        const rank = availableIndex >= 0 ? availableIndex + 1 : '-';
                                        const responseTime = result.available ? `${Math.round(result.responseTime)}ms` : 'å¤±è´¥';
                                        const status = result.available ? 'æ­£å¸¸' : (result.error || 'æµ‹è¯•å¤±è´¥');
                                        const grade = result.available ? 
                                            (result.responseTime < 3000 ? 'ä¼˜ç§€' :
                                             result.responseTime < 6000 ? 'è‰¯å¥½' : 'ä¸€èˆ¬') : 'ä¸å¯ç”¨';
                                        const gradeClass = result.available ?
                                            (result.responseTime < 3000 ? 'text-success' :
                                             result.responseTime < 6000 ? 'text-warning' : 'text-info') : 'text-danger';
                                        const bestBadge = result.index === bestApiIndex && result.available ? ' ğŸ†' : '';
                                        
                                        return `
                                            <tr class="${result.index === bestApiIndex && result.available ? 'table-success' : ''}">
                                                <td>${rank}${bestBadge}</td>
                                                <td>${apiList[result.index].name}</td>
                                                <td>${responseTime}</td>
                                                <td><small>${status}</small></td>
                                                <td class="${gradeClass}"><small>${grade}</small></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb"></i> 
                                æ™ºèƒ½è§£æä¼šè‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„æ¥å£ã€‚å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œç³»ç»Ÿä¼šæä¾›åˆ‡æ¢å…¶ä»–æ¥å£çš„é€‰é¡¹ã€‚
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="button" class="btn btn-primary" onclick="performSpeedTestManual(); bootstrap.Modal.getInstance(document.querySelector('.modal')).hide();">
                            <i class="fas fa-redo"></i> é‡æ–°æµ‹é€Ÿ
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modal);
        });
    }
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <a href="compatibility-test.html" class="btn btn-primary" target="_blank">
                            <i class="fas fa-external-link-alt"></i> æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modal);
        });
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(message, type) {
        statusText.textContent = message;
        statusInfo.className = `status-info mt-4 show`;
        
        const alertDiv = statusInfo.querySelector('.alert');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 
                                          type === 'warning' ? 'warning' : 
                                          type === 'info' ? 'info' : 'success'} d-inline-block`;
        
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            statusInfo.classList.remove('show');
        }, 5000);
    }

    // æ˜¾ç¤ºå¸®åŠ©æ¨¡æ€æ¡†
    function showHelpModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-question-circle"></i> ä½¿ç”¨å¸®åŠ©</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="accordion" id="helpAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                        <i class="fas fa-play me-2"></i> å¦‚ä½•ä½¿ç”¨ï¼Ÿ
                                    </button>
                                </h2>
                                <div id="help1" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>å¤åˆ¶æ‚¨æƒ³è¦è§‚çœ‹çš„VIPè§†é¢‘é“¾æ¥</li>
                                            <li>å°†é“¾æ¥ç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­</li>
                                            <li>ç‚¹å‡»"æ™ºèƒ½è§£æ"æŒ‰é’®</li>
                                            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„è§£ææ¥å£</li>
                                            <li>å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå¯ä»¥å°è¯•åˆ‡æ¢å…¶ä»–æ¥å£</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                        <i class="fas fa-list me-2"></i> æ”¯æŒå“ªäº›å¹³å°ï¼Ÿ
                                    </button>
                                </h2>
                                <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <ul class="list-unstyled">
                                                    <li><i class="fas fa-check text-success"></i> çˆ±å¥‡è‰º (iqiyi.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> è…¾è®¯è§†é¢‘ (v.qq.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> ä¼˜é…· (youku.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> èŠ’æœTV (mgtv.com)</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <ul class="list-unstyled">
                                                    <li><i class="fas fa-check text-success"></i> æœç‹è§†é¢‘ (tv.sohu.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> å“”å“©å“”å“© (bilibili.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> 1905ç”µå½±ç½‘ (1905.com)</li>
                                                    <li><i class="fas fa-check text-success"></i> PPTV (pptv.com)</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                        <i class="fas fa-tachometer-alt me-2"></i> æ™ºèƒ½æµ‹é€Ÿæ˜¯ä»€ä¹ˆï¼Ÿ
                                    </button>
                                </h2>
                                <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>æ™ºèƒ½æµ‹é€ŸåŠŸèƒ½ä¼šè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰è§£ææ¥å£çš„å“åº”é€Ÿåº¦ï¼Œé€‰æ‹©æœ€å¿«çš„æ¥å£ä¸ºæ‚¨æä¾›æœåŠ¡ã€‚</p>
                                        <ul>
                                            <li>ğŸŸ¢ ç»¿è‰²ï¼šå“åº”é€Ÿåº¦å¿«ï¼ˆ&lt;2ç§’ï¼‰</li>
                                            <li>ğŸŸ¡ é»„è‰²ï¼šå“åº”é€Ÿåº¦ä¸­ç­‰ï¼ˆ2-5ç§’ï¼‰</li>
                                            <li>ğŸ”´ çº¢è‰²ï¼šå“åº”é€Ÿåº¦æ…¢ï¼ˆ&gt;5ç§’ï¼‰</li>
                                        </ul>
                                        <p>æ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç‚¹å‡»"æ¥å£æµ‹é€Ÿ"æŒ‰é’®é‡æ–°æµ‹è¯•ã€‚</p>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help4">
                                        <i class="fas fa-exclamation-triangle me-2"></i> å¸¸è§é—®é¢˜
                                    </button>
                                </h2>
                                <div id="help4" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <strong>Q: è§†é¢‘æ— æ³•æ’­æ”¾æ€ä¹ˆåŠï¼Ÿ</strong><br>
                                            A: å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š<br>
                                            1. åˆ‡æ¢å…¶ä»–è§£ææ¥å£<br>
                                            2. æ£€æŸ¥è§†é¢‘é“¾æ¥æ˜¯å¦æ­£ç¡®<br>
                                            3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•
                                        </div>
                                        <div class="mb-3">
                                            <strong>Q: ä¸ºä»€ä¹ˆæœ‰äº›è§†é¢‘è§£æå¤±è´¥ï¼Ÿ</strong><br>
                                            A: å¯èƒ½çš„åŸå› ï¼š<br>
                                            1. è§†é¢‘å¹³å°æ›´æ–°äº†é˜²æŠ¤æœºåˆ¶<br>
                                            2. è§£ææ¥å£ä¸´æ—¶ä¸å¯ç”¨<br>
                                            3. ç½‘ç»œè¿æ¥é—®é¢˜
                                        </div>
                                        <div>
                                            <strong>Q: æœ¬å·¥å…·å®‰å…¨å—ï¼Ÿ</strong><br>
                                            A: æœ¬å·¥å…·å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šæ”¶é›†ä»»ä½•ä¸ªäººä¿¡æ¯ï¼Œæºä»£ç å®Œå…¨å¼€æºã€‚
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <a href="https://github.com/zhikanyeye/Free-VIP-Video-Unlock" class="btn btn-primary" target="_blank">
                            <i class="fab fa-github"></i> æŸ¥çœ‹æºç 
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modal);
        });
    }
    
    // è§†é¢‘è§£æå‡½æ•°
    async function parseVideo() {
        const url = videoUrlInput.value.trim();
        
        // éªŒè¯URL
        if (!url) {
            showNotification('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
            return;
        }
        
        if (!isValidUrl(url)) {
            showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'error');
            return;
        }
        
        // æ£€æµ‹è§†é¢‘å¹³å°
        const platform = detectPlatform(url);
        if (!platform) {
            showNotification('ä¸æ”¯æŒçš„è§†é¢‘å¹³å°ï¼Œè¯·å°è¯•å…¶ä»–é“¾æ¥', 'error');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        parseBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ™ºèƒ½è§£æä¸­...';
        parseBtn.disabled = true;
        updateStatus('å¼€å§‹æ™ºèƒ½è§£æè§†é¢‘...', 'info');

        try {
            // æ ¸å¿ƒæ”¹å˜ï¼šæ¯æ¬¡è§£æéƒ½è¿›è¡Œæ™ºèƒ½æµ‹é€Ÿï¼Œä½¿ç”¨å½“å‰è§†é¢‘é“¾æ¥è¿›è¡Œå®é™…æµ‹è¯•
            updateStatus('æ­£åœ¨æ™ºèƒ½æ£€æµ‹æœ€ä½³è§£ææ¥å£ï¼Œè¯·ç¨å€™...', 'info');
            await performSpeedTest();
            
            // ä½¿ç”¨æµ‹é€Ÿåé€‰æ‹©çš„æœ€ä½³æ¥å£
            const bestApi = apiList[bestApiIndex];
            updateStatus(`ä½¿ç”¨æœ€ä½³æ¥å£ ${bestApi.name} è§£æè§†é¢‘...`, 'info');
            
            // æ„å»ºå®Œæ•´çš„è§†é¢‘URL
            const fullVideoUrl = bestApi.url + encodeURIComponent(url);
            const videoInfo = {
                platform: platform,
                apiName: bestApi.name,
                originalUrl: url,
                fullUrl: fullVideoUrl
            };
            
            // æ›´æ–°ç•Œé¢ä¿¡æ¯
            videoTitle.textContent = `æ­£åœ¨æ’­æ”¾: ${platform} è§†é¢‘`;
            apiNameBadge.textContent = `${bestApi.name} (æœ€ä½³)`;
            
            // å°è¯•ä½¿ç”¨ DPlayerï¼Œå¤±è´¥åˆ™ä½¿ç”¨ iframe
            const dplayerSuccess = deviceInfo.isMobile ? 
                false : // ç§»åŠ¨ç«¯ç›´æ¥ä½¿ç”¨ iframe æ›´ç¨³å®š
                await tryDPlayerFirst(fullVideoUrl, videoInfo);
            
            if (!dplayerSuccess) {
                fallbackToIframe(videoInfo);
            }
            
            // æ˜¾ç¤ºæ’­æ”¾å™¨
            playerSection.classList.remove('d-none');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            parseBtn.innerHTML = '<i class="fas fa-search"></i> æ™ºèƒ½è§£æ';
            parseBtn.disabled = false;
            
            // æ»šåŠ¨åˆ°æ’­æ”¾å™¨
            playerSection.scrollIntoView({ behavior: 'smooth' });
            
            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥å’Œæµ‹é€Ÿç»“æœ
            const responseTime = speedTestResults.find(r => r.index === bestApiIndex)?.responseTime;
            const timeDisplay = responseTime ? ` (${Math.round(responseTime)}ms)` : '';
            
            showNotification(`è§†é¢‘è§£ææˆåŠŸï¼ä½¿ç”¨æœ€ä½³æ¥å£ï¼š${bestApi.name}${timeDisplay}`, 'success');
            updateStatus(`è§£ææˆåŠŸï¼Œæ­£åœ¨æ’­æ”¾ ${platform} è§†é¢‘`, 'success');
            
            // æ·»åŠ é‡è¯•æœºåˆ¶ï¼ŒåŒ…å«æ™ºèƒ½æµ‹é€Ÿç»“æœ
            addRetryMechanism(url, platform);
            
        } catch (error) {
            parseBtn.innerHTML = '<i class="fas fa-search"></i> æ™ºèƒ½è§£æ';
            parseBtn.disabled = false;
            showNotification('æ™ºèƒ½è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            updateStatus('è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æˆ–ç½‘ç»œè¿æ¥', 'error');
        }

    // å°è¯•ä½¿ç”¨ DPlayer
    async function tryDPlayerFirst(videoUrl, videoInfo) {
        try {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ DPlayer
            if (typeof DPlayer === 'undefined') {
                console.warn('DPlayer æœªåŠ è½½');
                return false;
            }
            
            // å¯¹äºæŸäº›è§£ææ¥å£ï¼Œç›´æ¥æå–è§†é¢‘æµURL
            const directVideoUrl = await extractDirectVideoUrl(videoUrl);
            const finalUrl = directVideoUrl || videoUrl;
            
            return initializeDPlayer(finalUrl, videoInfo);
        } catch (error) {
            console.error('DPlayer å°è¯•å¤±è´¥:', error);
            return false;
        }
    }

    // æå–ç›´æ¥è§†é¢‘æµURL (å¯é€‰åŠŸèƒ½)
    async function extractDirectVideoUrl(parseUrl) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥æå–ç›´æ¥çš„è§†é¢‘æµURL
        // ç›®å‰ç›´æ¥è¿”å›nullï¼Œä½¿ç”¨åŸå§‹è§£æURL
        return null;
    }
    }

    // æ™ºèƒ½æµ‹é€Ÿå‡½æ•° - é‡æ–°è®¾è®¡ä¸ºå®é™…æµ‹è¯•è§£ææ¥å£
    async function performSpeedTest() {
        if (isSpeedTesting) return;
        
        isSpeedTesting = true;
        speedTestResults = [];
        
        // è·å–å½“å‰è¾“å…¥çš„è§†é¢‘é“¾æ¥è¿›è¡Œæµ‹è¯•
        const testVideoUrl = videoUrlInput.value.trim();
        if (!testVideoUrl) {
            isSpeedTesting = false;
            return;
        }
        
        updateStatus('æ­£åœ¨æµ‹è¯•æ‰€æœ‰è§£ææ¥å£é€Ÿåº¦...', 'info');
        
        const testPromises = apiList.map(async (api, index) => {
            try {
                const startTime = performance.now();
                const fullParseUrl = api.url + encodeURIComponent(testVideoUrl);
                
                // å®é™…æµ‹è¯•è§£ææ¥å£çš„å“åº”é€Ÿåº¦
                const testResult = await testParseInterface(fullParseUrl, api.name, index);
                
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                return {
                    index: index,
                    responseTime: responseTime,
                    available: testResult.success,
                    error: testResult.error,
                    loadTime: testResult.loadTime
                };
            } catch (error) {
                return {
                    index: index,
                    responseTime: 15000, // ç»™å¤±è´¥çš„æ¥å£ä¸€ä¸ªå¾ˆé«˜çš„æ—¶é—´æƒ©ç½š
                    available: false,
                    error: error.message,
                    loadTime: 0
                };
            }
        });
        
        try {
            // æ˜¾ç¤ºæµ‹è¯•è¿›åº¦
            showTestProgress();
            
            speedTestResults = await Promise.all(testPromises);
            
            // è¿‡æ»¤å‡ºå¯ç”¨çš„æ¥å£å¹¶æŒ‰é€Ÿåº¦æ’åº
            const availableResults = speedTestResults.filter(r => r.available);
            
            if (availableResults.length > 0) {
                availableResults.sort((a, b) => a.responseTime - b.responseTime);
                bestApiIndex = availableResults[0].index;
                
                const bestApi = apiList[bestApiIndex];
                const responseTime = Math.round(availableResults[0].responseTime);
                
                updateStatus(`æ™ºèƒ½æµ‹é€Ÿå®Œæˆï¼æœ€ä½³æ¥å£ï¼š${bestApi.name} (${responseTime}ms)`, 'success');
                showNotification(`å·²é€‰æ‹©æœ€å¿«æ¥å£ï¼š${bestApi.name}`, 'success');
            } else {
                // å¦‚æœæ‰€æœ‰æ¥å£éƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤ç¬¬ä¸€ä¸ª
                bestApiIndex = 0;
                updateStatus('æ‰€æœ‰æ¥å£æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¥å£', 'warning');
                showNotification('æ¥å£æµ‹è¯•å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ¥å£å°è¯•æ’­æ”¾', 'warning');
            }
            
        } catch (error) {
            bestApiIndex = 0;
            updateStatus('æ™ºèƒ½æµ‹é€Ÿå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¥å£', 'error');
            showNotification('æ™ºèƒ½æµ‹é€Ÿå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¥å£', 'error');
        } finally {
            isSpeedTesting = false;
            hideTestProgress();
        }
    }

    // æµ‹è¯•è§£ææ¥å£çš„å®é™…å“åº”
    async function testParseInterface(parseUrl, apiName, apiIndex) {
        return new Promise((resolve) => {
            const startTime = performance.now();
            const iframe = document.createElement('iframe');
            
            // è®¾ç½®iframeæ ·å¼
            iframe.style.display = 'none';
            iframe.style.width = '1px';
            iframe.style.height = '1px';
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            
            let resolved = false;
            let loadStarted = false;
            
            // è®¾ç½®è¶…æ—¶
            const timeout = setTimeout(() => {
                if (!resolved) {
                    resolved = true;
                    cleanup();
                    resolve({
                        success: false,
                        error: 'å“åº”è¶…æ—¶',
                        loadTime: performance.now() - startTime
                    });
                }
            }, 8000); // 8ç§’è¶…æ—¶
            
            // æ¸…ç†å‡½æ•°
            const cleanup = () => {
                clearTimeout(timeout);
                if (iframe.parentNode) {
                    document.body.removeChild(iframe);
                }
                updateApiTestStatus(apiIndex, resolved ? 'completed' : 'timeout');
            };
            
            // ç›‘å¬åŠ è½½äº‹ä»¶
            iframe.onload = () => {
                if (!resolved) {
                    resolved = true;
                    const loadTime = performance.now() - startTime;
                    cleanup();
                    
                    // æ£€æŸ¥iframeæ˜¯å¦çœŸæ­£åŠ è½½äº†å†…å®¹
                    setTimeout(() => {
                        resolve({
                            success: true,
                            error: null,
                            loadTime: loadTime
                        });
                    }, 500); // ç»™iframeä¸€äº›æ—¶é—´æ¥æ¸²æŸ“
                }
            };
            
            // ç›‘å¬é”™è¯¯äº‹ä»¶
            iframe.onerror = () => {
                if (!resolved) {
                    resolved = true;
                    cleanup();
                    resolve({
                        success: false,
                        error: 'åŠ è½½å¤±è´¥',
                        loadTime: performance.now() - startTime
                    });
                }
            };
            
            // ç›‘å¬åŠ è½½å¼€å§‹
            iframe.addEventListener('loadstart', () => {
                loadStarted = true;
                updateApiTestStatus(apiIndex, 'loading');
            });
            
            // å¼€å§‹æµ‹è¯•
            updateApiTestStatus(apiIndex, 'testing');
            document.body.appendChild(iframe);
            
            try {
                iframe.src = parseUrl;
            } catch (error) {
                if (!resolved) {
                    resolved = true;
                    cleanup();
                    resolve({
                        success: false,
                        error: 'è®¾ç½®URLå¤±è´¥',
                        loadTime: performance.now() - startTime
                    });
                }
            }
        });
    }

    // æ˜¾ç¤ºæµ‹è¯•è¿›åº¦
    function showTestProgress() {
        // åœ¨çŠ¶æ€åŒºåŸŸæ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•è¿›åº¦
        const progressHtml = `
            <div class="mt-3">
                <div class="progress mb-2">
                    <div id="speedtest-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="api-test-status" class="small">
                    ${apiList.map((api, index) => `
                        <div id="status-${index}" class="d-flex justify-content-between align-items-center mb-1">
                            <span>${api.name}</span>
                            <span class="text-muted">ç­‰å¾…æµ‹è¯•...</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // æ·»åŠ åˆ°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
        const statusDiv = statusInfo.querySelector('.alert');
        statusDiv.insertAdjacentHTML('beforeend', progressHtml);
    }

    // éšè—æµ‹è¯•è¿›åº¦
    function hideTestProgress() {
        const progressElement = document.getElementById('speedtest-progress');
        const statusElement = document.getElementById('api-test-status');
        
        if (progressElement && progressElement.parentNode) {
            progressElement.parentNode.parentNode.remove();
        }
        if (statusElement && statusElement.parentNode) {
            statusElement.remove();
        }
    }

    // æ›´æ–°APIæµ‹è¯•çŠ¶æ€
    function updateApiTestStatus(apiIndex, status) {
        const statusElement = document.getElementById(`status-${apiIndex}`);
        if (!statusElement) return;
        
        const statusSpan = statusElement.querySelector('span:last-child');
        if (!statusSpan) return;
        
        let statusText = '';
        let statusClass = 'text-muted';
        
        switch (status) {
            case 'testing':
                statusText = 'æ­£åœ¨æµ‹è¯•...';
                statusClass = 'text-primary';
                break;
            case 'loading':
                statusText = 'æ­£åœ¨åŠ è½½...';
                statusClass = 'text-info';
                break;
            case 'completed':
                statusText = 'æµ‹è¯•å®Œæˆ';
                statusClass = 'text-success';
                break;
            case 'timeout':
                statusText = 'å“åº”è¶…æ—¶';
                statusClass = 'text-warning';
                break;
            case 'error':
                statusText = 'æµ‹è¯•å¤±è´¥';
                statusClass = 'text-danger';
                break;
        }
        
        statusSpan.textContent = statusText;
        statusSpan.className = statusClass;
        
        // æ›´æ–°æ€»ä½“è¿›åº¦
        const completedCount = apiList.filter((_, index) => {
            const elem = document.getElementById(`status-${index}`);
            if (!elem) return false;
            const span = elem.querySelector('span:last-child');
            return span && !span.textContent.includes('ç­‰å¾…') && !span.textContent.includes('æµ‹è¯•ä¸­');
        }).length;
        
        const progressBar = document.getElementById('speedtest-progress');
        if (progressBar) {
            const percentage = (completedCount / apiList.length) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${Math.round(percentage)}%`;
        }
    }

    // æ·»åŠ é‡è¯•æœºåˆ¶
    function addRetryMechanism(url, platform) {
        // åœ¨æ’­æ”¾å™¨ä¸‹æ–¹æ·»åŠ é‡è¯•æŒ‰é’®
        const retryContainer = document.createElement('div');
        retryContainer.className = 'text-center mt-3';
        retryContainer.innerHTML = `
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="retryWithNextApi('${url}', '${platform}')">
                    <i class="fas fa-redo"></i> æ¢ä¸ªæ¥å£é‡è¯•
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="showApiList()">
                    <i class="fas fa-list"></i> æŸ¥çœ‹æ‰€æœ‰æ¥å£
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="performSpeedTest()">
                    <i class="fas fa-tachometer-alt"></i> é‡æ–°æµ‹é€Ÿ
                </button>
            </div>
        `;
        
        // ç§»é™¤æ—§çš„é‡è¯•å®¹å™¨
        const oldRetry = document.querySelector('.retry-container');
        if (oldRetry) {
            oldRetry.remove();
        }
        
        retryContainer.className += ' retry-container';
        document.querySelector('#playerSection .card-body').appendChild(retryContainer);
    }

    // å…¨å±€å‡½æ•°ï¼šä½¿ç”¨ä¸‹ä¸€ä¸ªæ¥å£é‡è¯•
    window.retryWithNextApi = async function(url, platform) {
        bestApiIndex = (bestApiIndex + 1) % apiList.length;
        const api = apiList[bestApiIndex];
        
        const fullVideoUrl = api.url + encodeURIComponent(url);
        const videoInfo = {
            platform: platform,
            apiName: api.name,
            originalUrl: url,
            fullUrl: fullVideoUrl
        };
        
        // æ›´æ–°ç•Œé¢ä¿¡æ¯
        videoTitle.textContent = `æ­£åœ¨æ’­æ”¾: ${platform} è§†é¢‘`;
        apiNameBadge.textContent = api.name;
        
        // å°è¯•ä½¿ç”¨æ–°æ¥å£
        const dplayerSuccess = deviceInfo.isMobile ? 
            false : 
            await tryDPlayerFirst(fullVideoUrl, videoInfo);
        
        if (!dplayerSuccess) {
            fallbackToIframe(videoInfo);
        }
        
        showNotification(`å·²åˆ‡æ¢åˆ° ${api.name}`, 'info');
        updateStatus(`æ­£åœ¨ä½¿ç”¨ ${api.name} æ’­æ”¾è§†é¢‘`, 'info');
    };

    // å…¨å±€å‡½æ•°ï¼šæ˜¾ç¤ºæ¥å£åˆ—è¡¨
    window.showApiList = function() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-list"></i> è§£ææ¥å£åˆ—è¡¨</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                ç‚¹å‡»æ¥å£å¯åˆ‡æ¢ä½¿ç”¨ï¼Œç»¿è‰²è¡¨ç¤ºé€Ÿåº¦å¿«ï¼Œé»„è‰²è¡¨ç¤ºä¸­ç­‰ï¼Œçº¢è‰²è¡¨ç¤ºè¾ƒæ…¢
                            </small>
                        </div>
                        <div class="list-group">
                            ${apiList.map((api, index) => {
                                const result = speedTestResults.find(r => r.index === index);
                                const responseTime = result ? Math.round(result.responseTime) : 'æœªæµ‹è¯•';
                                const available = result ? result.available : true;
                                const isBest = index === bestApiIndex;
                                
                                let statusClass = 'slow';
                                let statusText = 'è¾ƒæ…¢';
                                if (result && result.responseTime < 2000) {
                                    statusClass = 'fast';
                                    statusText = 'å¿«é€Ÿ';
                                } else if (result && result.responseTime < 5000) {
                                    statusClass = 'medium';
                                    statusText = 'ä¸­ç­‰';
                                }
                                
                                return `
                                    <div class="list-group-item list-group-item-action ${isBest ? 'active' : ''}" onclick="selectApi(${index})" style="cursor: pointer;">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="api-status ${statusClass}"></span>
                                                <div>
                                                    <h6 class="mb-1">
                                                        ${api.name} 
                                                        ${isBest ? '<span class="badge bg-primary ms-2">å½“å‰æœ€ä½³</span>' : ''}
                                                        ${!available ? '<span class="badge bg-danger ms-2">ä¸å¯ç”¨</span>' : ''}
                                                    </h6>
                                                    <small class="text-muted">${api.url}</small>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="fw-bold">${responseTime === 'æœªæµ‹è¯•' ? responseTime : responseTime + 'ms'}</div>
                                                <small class="text-muted">${result ? statusText : 'æœªæµ‹è¯•'}</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-outline-primary" onclick="performSpeedTestFromModal()">
                                <i class="fas fa-sync-alt"></i> é‡æ–°æµ‹é€Ÿ
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modal);
        });
    };

    // ä»æ¨¡æ€æ¡†ä¸­é‡æ–°æµ‹é€Ÿ
    window.performSpeedTestFromModal = async function() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æµ‹é€Ÿä¸­...';
        button.disabled = true;
        
        try {
            await performSpeedTest();
            // åˆ·æ–°æ¨¡æ€æ¡†å†…å®¹
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
            if (modal) {
                modal.hide();
                setTimeout(() => showApiList(), 300);
            }
        } catch (error) {
            showNotification('æµ‹é€Ÿå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    };

    // å…¨å±€å‡½æ•°ï¼šé€‰æ‹©ç‰¹å®šæ¥å£
    window.selectApi = function(index) {
        bestApiIndex = index;
        const url = videoUrlInput.value.trim();
        const platform = detectPlatform(url);
        
        if (url && platform) {
            retryWithNextApi(url, platform);
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
        if (modal) {
            modal.hide();
        }
    };
    
    // æ£€æµ‹è§†é¢‘å¹³å°
    function detectPlatform(url) {
        // æ”¯æŒçš„è§†é¢‘å¹³å°åŸŸå
        const platforms = {
            'iqiyi.com': 'çˆ±å¥‡è‰º',
            'v.qq.com': 'è…¾è®¯è§†é¢‘',
            'youku.com': 'ä¼˜é…·',
            'mgtv.com': 'èŠ’æœTV',
            'tv.sohu.com': 'æœç‹è§†é¢‘',
            'bilibili.com': 'å“”å“©å“”å“©',
            '1905.com': '1905ç”µå½±ç½‘',
            'pptv.com': 'PPTV'
        };
        
        try {
            const domain = new URL(url).hostname;
            
            // æ£€æŸ¥URLæ˜¯å¦åŒ…å«æ”¯æŒçš„å¹³å°åŸŸå
            for (const key in platforms) {
                if (domain.includes(key)) {
                    return platforms[key];
                }
            }
        } catch (e) {
            return null;
        }
        
        return null;
    }
    
    // éªŒè¯URL
    function isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch (e) {
            return false;
        }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type) {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        const alertType = type === 'error' ? 'danger' : 
                         type === 'warning' ? 'warning' : 
                         type === 'info' ? 'info' : 'success';
        
        notification.className = `alert alert-${alertType} notification`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.maxWidth = '350px';
        notification.style.padding = '12px 20px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
        notification.style.backdropFilter = 'blur(10px)';
        notification.style.border = 'none';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                                   type === 'warning' ? 'exclamation-circle' : 
                                   type === 'info' ? 'info-circle' : 'check-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);
        
        // æ·»åŠ è¿›å…¥åŠ¨ç”»
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        notification.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // 4ç§’åè‡ªåŠ¨åˆ é™¤
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentElement) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }
    
    // åˆå§‹åŒ–æ£€æŸ¥å‰ªè´´æ¿
    function checkClipboard() {
        // è¯·æ±‚å‰ªè´´æ¿æƒé™å¹¶æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘URL
        if (navigator.clipboard && navigator.clipboard.readText) {
            navigator.clipboard.readText()
                .then(text => {
                    if (text && isValidUrl(text) && detectPlatform(text)) {
                        videoUrlInput.value = text;
                        showNotification('å·²è‡ªåŠ¨ç²˜è´´å‰ªè´´æ¿ä¸­çš„è§†é¢‘é“¾æ¥', 'success');
                    }
                })
                .catch(() => {
                    // ç”¨æˆ·æœªæˆäºˆæƒé™æˆ–å…¶ä»–é”™è¯¯ï¼Œé™é»˜å¤±è´¥
                });
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å‰ªè´´æ¿
    // æ³¨ï¼šè®¸å¤šæµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½è®¿é—®å‰ªè´´æ¿
    document.addEventListener('click', function() {
        // é¦–æ¬¡ç‚¹å‡»é¡µé¢æ—¶å°è¯•æ£€æŸ¥å‰ªè´´æ¿
        if (!window.clipboardChecked) {
            checkClipboard();
            window.clipboardChecked = true;
        }
    }, { once: true });

    // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç† (ç§»åŠ¨ç«¯ä¼˜åŒ–)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && dplayer) {
            // é¡µé¢éšè—æ—¶æš‚åœæ’­æ”¾ (èŠ‚çœèµ„æº)
            dplayer.pause();
        }
    });

    // ç½‘ç»œçŠ¶æ€ç›‘æµ‹ (ç§»åŠ¨ç«¯é‡è¦)
    if ('connection' in navigator) {
        function updateNetworkStatus() {
            const connection = navigator.connection;
            const speed = connection.effectiveType;
            
            if (speed === 'slow-2g' || speed === '2g') {
                showNotification('ç½‘ç»œè¾ƒæ…¢ï¼Œå»ºè®®ä½¿ç”¨è¾ƒä½è´¨é‡çš„è§£ææ¥å£', 'warning');
            }
        }
        
        navigator.connection.addEventListener('change', updateNetworkStatus);
        updateNetworkStatus(); // åˆå§‹æ£€æµ‹
    }

    // è®¾å¤‡æ–¹å‘å˜åŒ–å¤„ç†
    if (deviceInfo.isMobile) {
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                // æ–¹å‘å˜åŒ–åé‡æ–°è°ƒæ•´æ’­æ”¾å™¨å°ºå¯¸
                if (dplayer) {
                    dplayer.resize();
                }
            }, 500);
        });
    }

    // é”™è¯¯æŠ¥å‘Šå’Œè°ƒè¯•ä¿¡æ¯
    window.addEventListener('error', function(e) {
        console.error('é¡µé¢é”™è¯¯:', e.error);
        
        // åœ¨å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            showNotification('å¼€å‘æ¨¡å¼ï¼šæ£€æµ‹åˆ°JavaScripté”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        }
    });

    // å¯¼å‡ºè®¾å¤‡ä¿¡æ¯ä¾›è°ƒè¯•ä½¿ç”¨
    window.debugInfo = {
        deviceInfo: deviceInfo,
        speedTestResults: () => speedTestResults,
        currentApi: () => apiList[bestApiIndex],
        dplayerInstance: () => dplayer
    };
});
